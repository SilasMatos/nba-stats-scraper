require('dotenv').config()
const express = require('express')
const cors = require('cors')

const matchupRoutes = require('./routes/matchup')
const playerRoutes = require('./routes/players')
const teamRoutes = require('./routes/teams')
const leagueRoutes = require('./routes/league')

const app = express()
const PORT = process.env.PORT || 3000

// ‚îÄ‚îÄ Middlewares ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.use(cors())
app.use(express.json())

// Log de requisi√ß√µes
app.use((req, _res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.originalUrl}`)
  next()
})

// ‚îÄ‚îÄ Rotas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.use('/api/matchup', matchupRoutes)
app.use('/api/players', playerRoutes)
app.use('/api/teams', teamRoutes)
app.use('/api', leagueRoutes) // standings, scores, leaders

// ‚îÄ‚îÄ Health check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.get('/api/health', (_req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() })
})

// ‚îÄ‚îÄ Rota raiz com documenta√ß√£o r√°pida ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.get('/', (_req, res) => {
  res.json({
    name: 'NBA Stats API',
    version: '1.0.0',
    endpoints: {
      // ‚îÄ‚îÄ CONFRONTOS (principal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      'GET /api/matchup/:teamA/vs/:teamB':
        'Relat√≥rio estat√≠stico completo de um confronto. Ex: /api/matchup/ATL/vs/MIA',
      'GET /api/matchup/:teamA/vs/:teamB/summary':
        'Resumo r√°pido do confronto com probabilidades',

      // ‚îÄ‚îÄ JOGADORES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      'GET /api/players/:name':
        'Stats de temporada de um jogador. Ex: /api/players/Trae-Young',
      'GET /api/players/:name/boxscores': '√öltimos boxscores do jogador',
      'GET /api/players/:name/props':
        'An√°lise de props com hit rate, desvio padr√£o e consist√™ncia',
      'GET /api/players/team/:team':
        'Todos os jogadores de um time com m√©dias. Ex: /api/players/team/ATL',

      // ‚îÄ‚îÄ TIMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      'GET /api/teams': 'Lista todos os times com stats resumidas',
      'GET /api/teams/rankings':
        'Ranking de times por score composto para apostas',
      'GET /api/teams/:team':
        'Detalhes completos de um time (off/def/h2h/roster)',
      'GET /api/teams/:team/standings': 'Classifica√ß√£o de um time',
      'GET /api/teams/:team/offense': 'Estat√≠sticas ofensivas',
      'GET /api/teams/:team/defense': 'Estat√≠sticas defensivas',

      // ‚îÄ‚îÄ LIGA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      'GET /api/standings': 'Classifica√ß√£o geral por confer√™ncia',
      'GET /api/scores':
        '√öltimos resultados com vencedor, margem e total de pts',
      'GET /api/leaders': 'Top 20 l√≠deres de liga agrupados por categoria',
      'GET /api/leaders/:category':
        'L√≠deres de uma categoria espec√≠fica. Ex: /api/leaders/scoring',

      // ‚îÄ‚îÄ OUTROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      'GET /api/health': 'Verifica√ß√£o de sa√∫de da API'
    },

    exemplos_de_uso: [
      'GET /api/matchup/ATL/vs/MIA',
      'GET /api/matchup/LAL/vs/BOS/summary',
      'GET /api/players/Trae-Young/props',
      'GET /api/players/team/LAL',
      'GET /api/teams/rankings',
      'GET /api/standings'
    ],

    times_disponiveis: [
      'ATL',
      'BOS',
      'BKN',
      'CHA',
      'CHI',
      'CLE',
      'DAL',
      'DEN',
      'DET',
      'GSW',
      'HOU',
      'IND',
      'LAC',
      'LAL',
      'MEM',
      'MIA',
      'MIL',
      'MIN',
      'NOP',
      'NYK',
      'OKC',
      'ORL',
      'PHI',
      'PHX',
      'POR',
      'SAC',
      'SAS',
      'TOR',
      'UTA',
      'WAS'
    ]
  })
})

// ‚îÄ‚îÄ 404 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.use((_req, res) => {
  res
    .status(404)
    .json({
      error: 'Rota n√£o encontrada. Acesse / para ver os endpoints dispon√≠veis.'
    })
})

// ‚îÄ‚îÄ Error handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.use((err, _req, res, _next) => {
  console.error('[ERROR]', err.message)
  res
    .status(500)
    .json({ error: 'Erro interno do servidor', details: err.message })
})

// ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.listen(PORT, () => {
  console.log(`\nüèÄ NBA Stats API rodando em http://localhost:${PORT}`)
  console.log(`   Documenta√ß√£o: http://localhost:${PORT}/`)
  console.log(
    `   Exemplo:      http://localhost:${PORT}/api/matchup/ATL/vs/MIA\n`
  )
})
